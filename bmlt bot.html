<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMLT Academic Bot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
         :root {
            --primary: #10a37f;
            --primary-dark: #0d8a6a;
            --primary-light: #e6f7f3;
            --text-primary: #343541;
            --text-secondary: #6e6e80;
            --bg-color: #ffffff;
            --sidebar-color: #f7f7f8;
            --message-bg-user: #f0f7ff;
            --message-bg-bot: #ffffff;
            --border-color: #e5e5e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --success: #10a37f;
            --warning: #f0ad4e;
            --danger: #d9534f;
            --info: #5bc0de;
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-yellow: #FBBC05;
            --google-green: #34A853;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-color);
            z-index: 10;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background-color: var(--primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logo-text {
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 5;
        }
        
        .sidebar-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .new-chat-btn:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-history {
            list-style: none;
        }
        
        .chat-history-item {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-history-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .chat-history-item-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-history-item-delete {
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 4px;
            display: none;
        }
        
        .chat-history-item:hover .chat-history-item-delete {
            display: block;
        }
        
        .chat-history-item-delete:hover {
            color: var(--danger);
            background-color: rgba(217, 83, 79, 0.1);
        }
        
        .sidebar-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .user-profile:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: bold;
        }
        
        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            padding-bottom: 0;
            scroll-behavior: smooth;
        }
        
        .message {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem 0;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .bot-avatar {
            background-color: var(--primary);
            color: white;
        }
        
        .message-content {
            flex: 1;
            padding-top: 0.25rem;
        }
        
        .user-message .message-content {
            align-items: flex-end;
            text-align: right;
        }
        
        .message-role {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .message-text {
            line-height: 1.7;
            font-size: 1rem;
            background-color: var(--message-bg-bot);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .user-message .message-text {
            background-color: var(--message-bg-user);
            border-top-right-radius: 0;
        }
        
        .bot-message .message-text {
            border-top-left-radius: 0;
        }
        
        .message-text p {
            margin-bottom: 1rem;
        }
        
        .message-text p:last-child {
            margin-bottom: 0;
        }
        
        .message-text a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .message-text a:hover {
            text-decoration: underline;
        }
        
        .message-text pre {
            background-color: var(--sidebar-color);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .message-text code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background-color: var(--sidebar-color);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .download-slide {
            display: inline-block;
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--primary-light);
            color: var(--primary);
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .download-slide:hover {
            background-color: rgba(16, 163, 127, 0.2);
        }
        
        .chat-input-container {
            padding: 1.5rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .chat-input-box {
            position: relative;
            border-radius: 8px;
            box-shadow: 0 0 0 1px var(--border-color), var(--shadow);
            transition: box-shadow 0.2s;
        }
        
        .chat-input-box:focus-within {
            box-shadow: 0 0 0 1px var(--primary), 0 0 0 4px rgba(16, 163, 127, 0.1);
        }
        
        .chat-input-textarea {
            width: 100%;
            border: none;
            resize: none;
            padding: 1rem 3rem 1rem 1rem;
            min-height: 60px;
            max-height: 200px;
            font-size: 1rem;
            line-height: 1.5;
            background-color: transparent;
            outline: none;
            color: var(--text-primary);
        }
        
        .chat-input-actions {
            position: absolute;
            right: 0.75rem;
            bottom: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input-button {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .chat-input-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        .chat-input-button.send {
            background-color: var(--primary);
            color: white;
        }
        
        .chat-input-button.send:hover {
            background-color: var(--primary-dark);
        }
        
        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }
        
        .upload-section {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--sidebar-color);
        }
        
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
        }
        
        .file-input-label {
            flex: 1;
            position: relative;
        }
        
        .file-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        .file-input-button {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            background-color: var(--bg-color);
            border: 1px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .file-input-button:hover {
            background-color: rgba(0, 0, 0, 0.02);
            border-color: var(--primary);
        }
        
        .upload-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .action-button.web-search {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .action-button.web-search:hover {
            background-color: rgba(16, 163, 127, 0.2);
        }
        
        .action-button.view-material {
            background-color: rgba(240, 173, 78, 0.1);
            color: var(--warning);
        }
        
        .action-button.view-material:hover {
            background-color: rgba(240, 173, 78, 0.2);
        }
        
        .action-button.ai-assistant {
            background-color: rgba(91, 192, 222, 0.1);
            color: var(--info);
        }
        
        .action-button.ai-assistant:hover {
            background-color: rgba(91, 192, 222, 0.2);
        }
        
        .action-button.forward-question {
            background-color: rgba(217, 83, 79, 0.1);
            color: var(--danger);
        }
        
        .action-button.forward-question:hover {
            background-color: rgba(217, 83, 79, 0.2);
        }
        
        .action-button.wikipedia-search {
            background-color: rgba(0, 121, 194, 0.1);
            color: #0079c2;
        }
        
        .action-button.wikipedia-search:hover {
            background-color: rgba(0, 121, 194, 0.2);
        }
        
        .action-button.google-search {
            background-color: rgba(66, 133, 244, 0.1);
            color: var(--google-blue);
        }
        
        .action-button.google-search:hover {
            background-color: rgba(66, 133, 244, 0.2);
        }
        
        .source-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        .mobile-menu-button {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-primary);
        }
        
        .forward-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .forward-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .forward-modal-content {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .forward-modal.active .forward-modal-content {
            transform: translateY(0);
        }
        
        .forward-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .forward-modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .forward-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .forward-modal-body {
            margin-bottom: 1.5rem;
        }
        
        .forward-method {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .forward-method:hover {
            background-color: var(--sidebar-color);
        }
        
        .forward-method-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .forward-method-icon.email {
            background-color: var(--danger);
        }
        
        .forward-method-icon.whatsapp {
            background-color: #25D366;
        }
        
        .forward-method-info {
            flex: 1;
        }
        
        .forward-method-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .forward-method-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .forward-modal-footer {
            display: flex;
            justify-content: flex-end;
        }
        
        .forward-modal-cancel {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            background-color: var(--sidebar-color);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .forward-modal-cancel:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .clear-history-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            background-color: var(--sidebar-color);
            border: none;
            cursor: pointer;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--danger);
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .clear-history-btn:hover {
            background-color: rgba(217, 83, 79, 0.1);
        }
        /* Cell structure styles */
        
        .cell-structure {
            margin: 1rem 0;
            border-collapse: collapse;
            width: 100%;
        }
        
        .cell-structure th,
        .cell-structure td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
        }
        
        .cell-structure th {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .cell-structure tr:nth-child(even) {
            background-color: var(--sidebar-color);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .mobile-menu-button {
                display: block;
            }
            .message {
                gap: 1rem;
                padding: 1rem 0;
            }
            .chat-messages {
                padding: 1rem;
                padding-bottom: 0;
            }
            .chat-input-container {
                padding: 1rem;
            }
            .upload-container {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .logo-text {
                display: none;
            }
            .message-avatar {
                width: 32px;
                height: 32px;
            }
            .message-content {
                padding-top: 0;
            }
            .action-buttons {
                gap: 0.5rem;
            }
            .action-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header>
            <button class="mobile-menu-button" id="mobile-menu-button">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <div class="logo-icon">B</div>
                <div class="logo-text">BMLT BOT</div>
            </div>
            <div></div>
            <!-- Empty div for spacing -->
        </header>

        <div class="chat-container">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="new-chat-btn">
                        <i class="fas fa-plus"></i>
                        <span>New chat</span>
                    </button>
                </div>
                <div class="sidebar-content">
                    <ul class="chat-history" id="chat-history">
                        <!-- Chat history items will be added here -->
                    </ul>
                </div>
                <div class="sidebar-footer">
                    <button class="clear-history-btn" id="clear-history-btn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Clear History</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar">BT</div>
                        <div class="user-name">USER</div>
                    </div>
                </div>
            </div>

            <div class="chat-main">
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot-message">
                        <div class="message-avatar bot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-role">BMLT BOT</div>
                            <div class="message-text">
                                <p>Hello! I'm your BMLT academic assistant created by Boadu Patrick. May I know your name so I can address you properly? Type just your name.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>BMLT BOT is typing...</span>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-box">
                        <textarea class="chat-input-textarea" id="message-input" placeholder="Message BMLT BOT..." rows="1" autocomplete="off"></textarea>
                        <div class="chat-input-actions">
                            <button class="chat-input-button" id="upload-trigger" title="Upload files">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="chat-input-button send" id="send-button" title="Send message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="upload-section">
                    <div class="upload-container">
                        <label class="file-input-label">
                            <input type="file" class="file-input" id="file-input" accept=".pdf,.ppt,.pptx,.doc,.docx,.txt" multiple>
                            <div class="file-input-button">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Upload lecture materials</span>
                            </div>
                        </label>
                    </div>
                    <div class="upload-info">Upload PDFs, PowerPoint, or Word documents for analysis</div>
                    <div id="upload-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forward Question Modal -->
    <div class="forward-modal" id="forward-modal">
        <div class="forward-modal-content">
            <div class="forward-modal-header">
                <div class="forward-modal-title">Forward Question</div>
                <button class="forward-modal-close" id="forward-modal-close">&times;</button>
            </div>
            <div class="forward-modal-body">
                <p>How would you like to forward this question?</p>
                <div class="forward-method" id="forward-email">
                    <div class="forward-method-icon email">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="forward-method-info">
                        <div class="forward-method-name">Email</div>
                        <div class="forward-method-description">Send via email to Boadu Patrick</div>
                    </div>
                </div>
                <div class="forward-method" id="forward-whatsapp">
                    <div class="forward-method-icon whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div class="forward-method-info">
                        <div class="forward-method-name">WhatsApp</div>
                        <div class="forward-method-description">Message Boadu Patrick directly via WhatsApp</div>
                    </div>
                </div>
            </div>
            <div class="forward-modal-footer">
                <button class="forward-modal-cancel" id="forward-modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

        // Configuration
        const ADMIN_WHATSAPP = '+233594982885';
        const ADMIN_EMAIL = 'patrickboadu878@gmail.com';
        const WIKIPEDIA_API_ENDPOINT = 'https://en.wikipedia.org/w/api.php?action=query&format=json&list=search&srlimit=3&origin=*&srsearch=';

        // Lecture slides data for BMLT courses with cell structure
        const LECTURE_SLIDES = {
            "medical genetics": {
                title: "Medical Genetics",
                downloadUrl: "slide/medical genetics.pptx",
                description: "Fundamentals of genetic inheritance, genetic disorders, and molecular diagnostics",
                cellStructure: {
                    components: [{
                        name: "Cell Membrane",
                        function: "Controls movement of substances in/out of cell"
                    }, {
                        name: "Nucleus",
                        function: "Contains genetic material (DNA)"
                    }, {
                        name: "Mitochondria",
                        function: "Produces energy (ATP)"
                    }, {
                        name: "Ribosomes",
                        function: "Protein synthesis"
                    }, {
                        name: "Endoplasmic Reticulum",
                        function: "Protein and lipid synthesis"
                    }, {
                        name: "Golgi Apparatus",
                        function: "Modifies, sorts, and packages proteins"
                    }],
                    geneticMaterial: {
                        dna: "Double helix structure with base pairs (A-T, C-G)",
                        chromosomes: "23 pairs in humans (22 autosomes + 1 sex chromosome)"
                    }
                }
            },
            "instrumentation and lab management": {
                title: "Instrumentation and Lab Management",
                downloadUrl: "slide/instru.pptx",
                description: "Laboratory equipment, quality control, and management principles",
                cellStructure: {
                    instruments: [{
                        name: "Microscope",
                        use: "Viewing microscopic specimens"
                    }, {
                        name: "Centrifuge",
                        use: "Separating components by density"
                    }, {
                        name: "Spectrophotometer",
                        use: "Measuring light absorbance"
                    }, {
                        name: "PCR Machine",
                        use: "Amplifying DNA segments"
                    }, {
                        name: "Autoclave",
                        use: "Sterilizing equipment"
                    }]
                }
            },
            "com skills": {
                title: "Communication Skills",
                downloadUrl: "slides/communication-skills.pptx",
                description: "Effective communication techniques for healthcare professionals",
                cellStructure: {
                    components: [{
                        name: "Verbal",
                        description: "Spoken words, tone, pace"
                    }, {
                        name: "Non-verbal",
                        description: "Body language, facial expressions"
                    }, {
                        name: "Written",
                        description: "Reports, documentation"
                    }, {
                        name: "Listening",
                        description: "Active listening skills"
                    }]
                }
            },
            "computer literacy": {
                title: "Computer Literacy",
                downloadUrl: "slides/computer-literacy.pptx",
                description: "Basic computer skills and applications in medical laboratory technology",
                cellStructure: {
                    components: [{
                        name: "Hardware",
                        description: "Physical components of a computer"
                    }, {
                        name: "Software",
                        description: "Programs and operating systems"
                    }, {
                        name: "Networking",
                        description: "Connecting computers and devices"
                    }, {
                        name: "LIS",
                        description: "Laboratory Information System"
                    }]
                }
            },
            "biophysics": {
                title: "Biophysics",
                downloadUrl: "slides/biophysics.pptx",
                description: "Physical principles applied to biological systems and medical technology",
                cellStructure: {
                    topics: [{
                        name: "Membrane Transport",
                        description: "Diffusion, osmosis, active transport"
                    }, {
                        name: "Bioelectricity",
                        description: "Nerve impulses, membrane potentials"
                    }, {
                        name: "Biomechanics",
                        description: "Forces in biological systems"
                    }, {
                        name: "Medical Imaging",
                        description: "X-ray, MRI, ultrasound principles"
                    }]
                }
            },
            "chemistry": {
                title: "Chemistry",
                downloadUrl: "slides/chemistry.pptx",
                description: "Chemical principles relevant to medical laboratory science",
                cellStructure: {
                    components: [{
                        name: "Atoms",
                        description: "Basic units of matter"
                    }, {
                        name: "Molecules",
                        description: "Combinations of atoms"
                    }, {
                        name: "Bonds",
                        description: "Ionic, covalent, hydrogen"
                    }, {
                        name: "Reactions",
                        description: "Chemical changes in substances"
                    }]
                }
            },
            "mathematics": {
                title: "Mathematics",
                downloadUrl: "slides/mathematics.pptx",
                description: "Mathematical concepts and calculations for laboratory applications",
                cellStructure: {
                    topics: [{
                        name: "Dilutions",
                        description: "Calculating concentration changes"
                    }, {
                        name: "Statistics",
                        description: "Mean, median, standard deviation"
                    }, {
                        name: "Graphing",
                        description: "Plotting and interpreting data"
                    }, {
                        name: "Unit Conversions",
                        description: "Metric system conversions"
                    }]
                }
            }
        };

        // Pre-defined AI responses for common BMLT questions
        const AI_RESPONSES = {
            "what is bmlt": "BMLT stands for Bachelor of Medical Laboratory Technology. It's an undergraduate degree program that trains students to become medical laboratory technologists who perform diagnostic tests on patient samples to help diagnose, treat, and prevent diseases.",
            "hematology tests": "Common hematology tests include:\n1. Complete Blood Count (CBC)\n2. Hemoglobin and Hematocrit\n3. Blood Smear Examination\n4. Coagulation Tests (PT, APTT)\n5. Erythrocyte Sedimentation Rate (ESR)\nThese tests help diagnose blood disorders, infections, and other conditions.",
            "microbiology techniques": "Key microbiology techniques include:\n- Gram staining\n- Culture and sensitivity testing\n- Biochemical tests for bacterial identification\n- Antibiotic susceptibility testing\n- Molecular techniques like PCR\nThese methods help identify microorganisms causing infections.",
            "clinical biochemistry": "Important clinical biochemistry tests include:\n1. Liver function tests (LFTs)\n2. Renal function tests (RFTs)\n3. Lipid profile\n4. Glucose tests\n5. Electrolyte analysis\nThese tests assess organ function and metabolic status.",
            "immunology tests": "Common immunology tests include:\n- ELISA (Enzyme-Linked Immunosorbent Assay)\n- Western blot\n- Immunofluorescence\n- Flow cytometry\n- Agglutination tests\nThese detect antibodies, antigens, and immune system components.",
            "histopathology": "Histopathology involves:\n1. Tissue fixation\n2. Processing and embedding\n3. Sectioning with microtome\n4. Staining (H&E, special stains)\n5. Microscopic examination\nUsed to diagnose diseases at tissue level.",
            "medical genetics": "Medical genetics covers:\n- Patterns of inheritance\n- Chromosomal abnormalities\n- Genetic testing methods\n- Molecular diagnostics\n- Genetic counseling\nEssential for diagnosing genetic disorders.",
            "instrumentation": "Lab instrumentation includes:\n- Microscopes\n- Centrifuges\n- Spectrophotometers\n- Automated analyzers\n- PCR machines\nUnderstanding these is crucial for accurate testing.",
            "lab management": "Lab management principles:\n- Quality assurance\n- Safety protocols\n- Inventory control\n- Personnel management\n- Accreditation standards\nEnsures efficient lab operations."
        };

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');
            const fileInput = document.getElementById('file-input');
            const uploadTrigger = document.getElementById('upload-trigger');
            const uploadStatus = document.getElementById('upload-status');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.getElementById('sidebar');
            const newChatBtn = document.getElementById('new-chat-btn');
            const forwardModal = document.getElementById('forward-modal');
            const forwardModalClose = document.getElementById('forward-modal-close');
            const forwardModalCancel = document.getElementById('forward-modal-cancel');
            const forwardEmail = document.getElementById('forward-email');
            const forwardWhatsapp = document.getElementById('forward-whatsapp');
            const clearHistoryBtn = document.getElementById('clear-history-btn');

            // State variables
            let studentName = '';
            let isAskingForName = true;
            let uploadedDocuments = [];
            let currentQuestion = '';
            let chatHistory = [];

            // Initialize the app
            init();

            function init() {
                // Load chat history from localStorage
                const savedHistory = localStorage.getItem('chatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    renderChatHistory();
                }

                // Set up event listeners
                setupEventListeners();

                // Auto-resize textarea
                autoResizeTextarea();
            }

            function setupEventListeners() {
                // Send message on Enter (but allow Shift+Enter for new lines)
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // Send message on button click
                sendButton.addEventListener('click', sendMessage);

                // Upload file triggers
                uploadTrigger.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileUpload);

                // Mobile menu toggle
                mobileMenuButton.addEventListener('click', toggleSidebar);

                // New chat button
                newChatBtn.addEventListener('click', startNewChat);

                // Forward modal controls
                forwardModalClose.addEventListener('click', closeForwardModal);
                forwardModalCancel.addEventListener('click', closeForwardModal);
                forwardEmail.addEventListener('click', () => forwardQuestion('email'));
                forwardWhatsapp.addEventListener('click', () => forwardQuestion('whatsapp'));

                // Clear history button
                clearHistoryBtn.addEventListener('click', clearChatHistory);

                // Close modal when clicking outside
                forwardModal.addEventListener('click', function(e) {
                    if (e.target === forwardModal) {
                        closeForwardModal();
                    }
                });
            }

            function autoResizeTextarea() {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }

            function toggleSidebar() {
                sidebar.classList.toggle('active');
            }

            function startNewChat() {
                if (chatMessages.children.length > 1 || studentName) {
                    if (confirm('Start a new chat? Your current chat will be saved in history.')) {
                        // Save current chat to history if not empty
                        if (chatMessages.children.length > 1) {
                            saveCurrentChat();
                        }

                        // Reset state
                        studentName = '';
                        isAskingForName = true;
                        currentQuestion = '';

                        // Clear chat messages
                        chatMessages.innerHTML = `
                            <div class="message bot-message">
                                <div class="message-avatar bot-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    <div class="message-role">BMLT Assistant</div>
                                    <div class="message-text">
                                        <p>Hello! I'm your BMLT academic assistant created by Boadu Patrick. May I know your name so I can address you properly?</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            function saveCurrentChat() {
                const messages = Array.from(chatMessages.children).map(messageEl => {
                    const isBot = messageEl.classList.contains('bot-message');
                    const content = messageEl.querySelector('.message-text').innerHTML;
                    return {
                        role: isBot ? 'assistant' : 'user',
                        content: content
                    };
                });

                if (messages.length > 1) {
                    const chatTitle = messages[1].content.substring(0, 30) + (messages[1].content.length > 30 ? '...' : '');
                    const chatItem = {
                        id: Date.now(),
                        title: chatTitle,
                        messages: messages,
                        timestamp: new Date().toISOString()
                    };

                    chatHistory.unshift(chatItem);
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderChatHistory();
                }
            }

            function renderChatHistory() {
                const chatHistoryEl = document.getElementById('chat-history');
                chatHistoryEl.innerHTML = '';

                if (chatHistory.length === 0) {
                    const emptyMsg = document.createElement('li');
                    emptyMsg.className = 'chat-history-item';
                    emptyMsg.textContent = 'No chat history yet';
                    chatHistoryEl.appendChild(emptyMsg);
                    return;
                }

                chatHistory.forEach(chat => {
                    const li = document.createElement('li');
                    li.className = 'chat-history-item';

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'chat-history-item-content';
                    contentDiv.textContent = chat.title;

                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'chat-history-item-delete';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteChatItem(chat.id);
                    });

                    li.appendChild(contentDiv);
                    li.appendChild(deleteBtn);
                    li.addEventListener('click', () => loadChat(chat.id));
                    chatHistoryEl.appendChild(li);
                });
            }

            function deleteChatItem(chatId) {
                if (confirm('Are you sure you want to delete this chat?')) {
                    chatHistory = chatHistory.filter(chat => chat.id !== chatId);
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderChatHistory();
                }
            }

            function clearChatHistory() {
                if (chatHistory.length === 0) return;

                if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                    chatHistory = [];
                    localStorage.removeItem('chatHistory');
                    renderChatHistory();
                }
            }

            function loadChat(chatId) {
                const chat = chatHistory.find(c => c.id === chatId);
                if (!chat) return;

                // Save current chat if not empty
                if (chatMessages.children.length > 1) {
                    saveCurrentChat();
                }

                // Load the selected chat
                chatMessages.innerHTML = '';
                chat.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'assistant' ? 'bot-message' : 'user-message'}`;

                    messageDiv.innerHTML = `
                        <div class="message-avatar ${msg.role === 'assistant' ? 'bot-avatar' : 'user-avatar'}">
                            <i class="${msg.role === 'assistant' ? 'fas fa-robot' : 'fas fa-user'}"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-role">${msg.role === 'assistant' ? 'BMLT Assistant' : 'You'}</div>
                            <div class="message-text">${msg.content}</div>
                        </div>
                    `;

                    chatMessages.appendChild(messageDiv);
                });

                // Update state
                isAskingForName = false;
                if (chat.messages.length > 1) {
                    const firstBotMessage = chat.messages[0].content;
                    if (firstBotMessage.includes('Nice to meet you')) {
                        const nameMatch = firstBotMessage.match(/Nice to meet you, (.*?)!/);
                        if (nameMatch && nameMatch[1]) {
                            studentName = nameMatch[1];
                        }
                    }
                }

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addMessage(content, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

                messageDiv.innerHTML = `
                    <div class="message-avatar ${isUser ? 'user-avatar' : 'bot-avatar'}">
                        <i class="${isUser ? 'fas fa-user' : 'fas fa-robot'}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-role">${isUser ? 'You' : 'BMLT Assistant'}</div>
                        <div class="message-text">${content}</div>
                    </div>
                `;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showTyping() {
                typingIndicator.style.display = 'flex';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTyping() {
                typingIndicator.style.display = 'none';
            }

            function addBotResponse(response, actions = []) {
                showTyping();

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';

                messageDiv.innerHTML = `
                    <div class="message-avatar bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-role">BMLT Assistant</div>
                        <div class="message-text">${response}</div>
                    </div>
                `;

                chatMessages.appendChild(messageDiv);

                // Simulate typing effect
                const messageText = messageDiv.querySelector('.message-text');
                messageText.style.visibility = 'hidden';
                messageText.textContent = '';

                let i = 0;
                const typingInterval = setInterval(() => {
                    if (i < response.length) {
                        const char = response.charAt(i);
                        const isTag = char === '<';

                        if (isTag) {
                            // Skip to end of tag
                            const endTag = response.indexOf('>', i);
                            if (endTag !== -1) {
                                messageText.innerHTML += response.substring(i, endTag + 1);
                                i = endTag;
                            }
                        } else {
                            messageText.innerHTML += char;
                        }

                        i++;
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        clearInterval(typingInterval);
                        messageText.style.visibility = 'visible';
                        hideTyping();

                        if (actions.length > 0) {
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'action-buttons';

                            actions.forEach(action => {
                                const button = document.createElement('button');
                                button.className = `action-button ${action.class}`;
                                button.innerHTML = `<i class="${action.icon}"></i> ${action.text}`;
                                button.onclick = action.handler;
                                actionsDiv.appendChild(button);
                            });

                            messageDiv.querySelector('.message-content').appendChild(actionsDiv);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                }, 20);
            }

            function sendMessage() {
                const message = messageInput.value.trim();
                if (message === '') return;

                // Reset textarea height
                messageInput.style.height = 'auto';

                addMessage(message, true);
                messageInput.value = '';
                currentQuestion = message;

                if (isAskingForName) {
                    studentName = message;
                    isAskingForName = false;

                    setTimeout(() => {
                        const welcomeMessage = `Nice to meet you, ${studentName}! I'm your BMLT academic assistant. How can I help you today?<br><br>You can:
                        <ul>
                            <li>Ask me questions about your courses</li>
                            <li>Upload lecture materials for analysis</li>
                            <li>Request information from various sources</li>
                            <li>Download lecture slides when available</li>
                        </ul>`;
                        addBotResponse(welcomeMessage);
                    }, 1000);
                    return;
                }

                // Check if user is asking for slides
                if (isAskingForSlides(message)) {
                    handleSlideRequest(message);
                    return;
                }

                processUserMessage(message);
            }

            async function handleFileUpload() {
                const files = fileInput.files;
                if (files.length === 0) return;

                uploadStatus.textContent = `Processing ${files.length} file(s)...`;
                uploadStatus.style.color = 'var(--text-primary)';

                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        let content = '';
                        let docType = '';

                        if (file.name.endsWith('.pdf')) {
                            docType = 'PDF';
                            content = await extractTextFromPDF(file);
                        } else if (file.name.endsWith('.pptx') || file.name.endsWith('.ppt')) {
                            docType = 'PowerPoint';
                            content = await extractTextFromPPTX(file);
                        } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc') || file.name.endsWith('.txt')) {
                            docType = 'Text';
                            content = await extractTextFromDoc(file);
                        } else {
                            continue;
                        }

                        uploadedDocuments.push({
                            name: file.name,
                            type: docType,
                            size: file.size,
                            content: content
                        });
                    }

                    uploadStatus.textContent = `Successfully processed ${files.length} file(s)!`;
                    uploadStatus.style.color = 'var(--success)';

                    setTimeout(() => {
                        const uploadMessage = studentName ?
                            `Thank you for uploading materials, ${studentName}! I can now analyze these documents to help answer your questions.` :
                            "Thank you for uploading materials! I can now analyze these documents to help answer your questions.";
                        addBotResponse(uploadMessage);
                    }, 500);
                } catch (error) {
                    console.error('Error processing files:', error);
                    uploadStatus.textContent = "Error processing files. Please try again.";
                    uploadStatus.style.color = 'var(--danger)';
                } finally {
                    fileInput.value = '';
                }
            }

            async function extractTextFromPDF(file) {
                return new Promise((resolve, reject) => {
                    const fileReader = new FileReader();

                    fileReader.onload = async function() {
                        try {
                            const typedArray = new Uint8Array(this.result);
                            const pdf = await pdfjsLib.getDocument(typedArray).promise;
                            let fullText = '';

                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const text = textContent.items.map(item => item.str).join(' ');
                                fullText += text + '\n\n';
                            }

                            resolve(fullText);
                        } catch (error) {
                            reject(error);
                        }
                    };

                    fileReader.readAsArrayBuffer(file);
                });
            }

            async function extractTextFromPPTX(file) {
                return new Promise((resolve) => {
                    // Simulate text extraction (real implementation would require server-side processing)
                    setTimeout(() => {
                        resolve(`PowerPoint content extracted from ${file.name}\n\nSlide 1: Introduction\nSlide 2: Key Concepts\nSlide 3: Examples\nSlide 4: Summary`);
                    }, 1000);
                });
            }

            async function extractTextFromDoc(file) {
                return new Promise((resolve) => {
                    // Simulate text extraction (real implementation would require server-side processing)
                    setTimeout(() => {
                        resolve(`Text content extracted from ${file.name}\n\nThis is a simulated text extraction from a Word or text document.`);
                    }, 1000);
                });
            }

            async function searchWikipedia(query) {
                try {
                    const response = await fetch(`${WIKIPEDIA_API_ENDPOINT}${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.query && data.query.search && data.query.search.length > 0) {
                        let results = `<strong>Wikipedia results for "${query}":</strong><br><br>`;

                        data.query.search.forEach((result, index) => {
                            results += `<strong>${index + 1}. ${result.title}</strong><br>`;
                            results += `${result.snippet.replace(/<[^>]+>/g, '')}...<br>`;
                            results += `<a href="https://en.wikipedia.org/wiki/${encodeURIComponent(result.title.replace(/ /g, '_'))}" target="_blank">Read more</a><br><br>`;
                        });

                        return results;
                    } else {
                        return "No Wikipedia results found for your query.";
                    }
                } catch (error) {
                    console.error("Wikipedia search error:", error);
                    return "Sorry, I couldn't access Wikipedia right now. Please try again later.";
                }
            }

            async function searchGoogle(query) {
                // Simulate Google search since the API isn't free
                try {
                    // These would be real API results in a production environment
                    const simulatedResults = [{
                        title: "Medical Laboratory Technology - EduResource",
                        snippet: "Comprehensive guide to BMLT program covering all aspects of medical laboratory sciences and diagnostic techniques.",
                        link: "https://www.eduresource.org/bmlt"
                    }, {
                        title: "Hematology Tests and Procedures - LabMed",
                        snippet: "Detailed explanation of common hematology tests including CBC, blood smear, and coagulation studies.",
                        link: "https://www.labmed.org/hematology"
                    }, {
                        title: "Microbiology Techniques in Clinical Labs - MicroJournal",
                        snippet: "Overview of standard microbiological methods used in clinical laboratory settings for pathogen identification.",
                        link: "https://www.microjournal.org/clinical-techniques"
                    }];

                    let results = `<strong>Google search results for "${query}":</strong><br><br>`;

                    simulatedResults.forEach((result, index) => {
                        results += `<strong>${index + 1}. ${result.title}</strong><br>`;
                        results += `${result.snippet}<br>`;
                        results += `<a href="${result.link}" target="_blank">Visit page</a><br><br>`;
                    });

                    results += `<div class="source-info">Note: Patrick is working on it. This not what you are looking for</div>`;

                    return results;
                } catch (error) {
                    console.error("Google search error:", error);
                    return "Sorry, I couldn't perform a Google search right now. Please try again later.";
                }
            }

            async function callAIForHelp(query) {
                // Use pre-defined responses for common questions
                const lowerQuery = query.toLowerCase();
                let response = AI_RESPONSES[lowerQuery] ||
                    `Regarding "${query}", here's a general explanation:\n\n` +
                    `For more specific information, try searching Wikipedia or uploading relevant materials. ` +
                    `You can also ask me about:\n- Medical genetics\n- Instrumentation and lab management\n- Communication skills\n- Computer literacy\n- Biophysics\n- Chemistry\n- Mathematics`;

                return `<strong>AI Assistant response:</strong><br><br>${response.replace(/\n/g, '<br>')}<br><br><div class="source-info">AI-generated response based on pre-defined knowledge</div>`;
            }

            function handleSlideRequest(query) {
                // Find matching slides
                const lowerQuery = query.toLowerCase();
                let matchingSlides = [];

                for (const [key, slide] of Object.entries(LECTURE_SLIDES)) {
                    if (lowerQuery.includes(key) || slide.title.toLowerCase().includes(lowerQuery)) {
                        matchingSlides.push(slide);
                    }
                }

                if (matchingSlides.length > 0) {
                    let response = `<strong>Available lecture slides:</strong><br><br>`;

                    matchingSlides.forEach((slide, index) => {
                        response += `<strong>${index + 1}. ${slide.title}</strong><br>`;
                        response += `${slide.description}<br>`;
                        response += `<a href="${slide.downloadUrl}" class="download-slide" download><i class="fas fa-download"></i> Download Slides</a><br><br>`;

                        // Add cell structure information if available
                        if (slide.cellStructure) {
                            response += `<strong>Cell Structure Information:</strong><br>`;

                            if (slide.cellStructure.components) {
                                response += `<table class="cell-structure"><tr><th>Component</th><th>Description</th></tr>`;
                                slide.cellStructure.components.forEach(comp => {
                                    response += `<tr><td>${comp.name}</td><td>${comp.function || comp.description || comp.use}</td></tr>`;
                                });
                                response += `</table><br>`;
                            }

                            if (slide.cellStructure.geneticMaterial) {
                                response += `<strong>Genetic Material:</strong><br>`;
                                for (const [key, value] of Object.entries(slide.cellStructure.geneticMaterial)) {
                                    response += `<strong>${key}:</strong> ${value}<br>`;
                                }
                                response += `<br>`;
                            }
                        }
                    });

                    addBotResponse(response);
                } else {
                    addBotResponse("I couldn't find any slides matching your request. Here are all available slides:", [{
                        text: "View All Slides",
                        class: "view-material",
                        icon: "fas fa-images",
                        handler: () => {
                            let allSlidesResponse = `<strong>All Available Lecture Slides:</strong><br><br>`;
                            Object.values(LECTURE_SLIDES).forEach((slide, index) => {
                                allSlidesResponse += `<strong>${index + 1}. ${slide.title}</strong><br>`;
                                allSlidesResponse += `${slide.description}<br>`;
                                allSlidesResponse += `<a href="${slide.downloadUrl}" class="download-slide" download><i class="fas fa-download"></i> Download</a><br><br>`;
                            });
                            addBotResponse(allSlidesResponse);
                        }
                    }]);
                }
            }

            async function processUserMessage(message) {
                if (isGreeting(message)) {
                    setTimeout(() => {
                        const greetingResponse = studentName ?
                            `Hello again, ${studentName}! How can I assist you today?` :
                            "Hello! How can I assist you today?";
                        addBotResponse(greetingResponse);
                    }, 1000);
                    return;
                }

                if (isThankYou(message)) {
                    setTimeout(() => {
                        const thankYouResponse = studentName ?
                            `You're very welcome, ${studentName}! Is there anything else I can help you with?` :
                            "You're very welcome! Is there anything else I can help you with?";
                        addBotResponse(thankYouResponse);
                    }, 1000);
                    return;
                }

                if (isAskingAboutCapabilities(message)) {
                    setTimeout(() => {
                        const capabilitiesResponse = `I can help with various academic tasks including:
<ul>
    <li>Answering questions based on uploaded lecture materials (PDFs, PowerPoints, Word docs)</li>
    <li>Searching Wikipedia for reliable information</li>
    <li>Providing pre-defined explanations for common BMLT topics</li>
    <li>Forwarding complex questions to Boadu Patrick via email or WhatsApp</li>
    <li>Providing downloadable lecture slides when available</li>
    <li>Helping with research and study strategies</li>
</ul>
How would you like me to assist you today?`;
                        addBotResponse(capabilitiesResponse);
                    }, 1500);
                    return;
                }

                if (isAskingForContact(message)) {
                    setTimeout(() => {
                        const contactResponse = `You can contact Boadu Patrick directly:
<ul>
    <li><strong>WhatsApp:</strong> <a href="https://wa.me/${ADMIN_WHATSAPP}" target="_blank">${ADMIN_WHATSAPP}</a></li>
    <li><strong>Email:</strong> <a href="mailto:${ADMIN_EMAIL}">${ADMIN_EMAIL}</a></li>
</ul>
Would you like me to forward your question to him now?`;
                        addBotResponse(contactResponse, [{
                            text: "Forward Question",
                            class: "forward-question",
                            icon: "fas fa-share",
                            handler: () => openForwardModal(currentQuestion)
                        }]);
                    }, 1500);
                    return;
                }

                // First check uploaded documents
                if (uploadedDocuments.length > 0) {
                    showTyping();

                    try {
                        let foundResults = false;
                        let response = `Regarding "${message}":\n\n`;

                        for (const doc of uploadedDocuments) {
                            if (doc.content && typeof doc.content === 'string' && doc.content.toLowerCase().includes(message.toLowerCase())) {
                                foundResults = true;
                                const context = getContextFromContent(doc.content, message);
                                response += `<strong>From ${doc.name}:</strong>\n${context}\n\n`;
                            }
                        }

                        if (foundResults) {
                            setTimeout(() => {
                                response += "I found this information in your uploaded materials. Would you like me to look for more information?";
                                addBotResponse(response, [{
                                    text: "Search Wikipedia",
                                    class: "wikipedia-search",
                                    icon: "fab fa-wikipedia-w",
                                    handler: () => performWikipediaSearch(currentQuestion)
                                }, {
                                    text: "Google Search",
                                    class: "google-search",
                                    icon: "fab fa-google",
                                    handler: () => performGoogleSearch(currentQuestion)
                                }, {
                                    text: "AI Explanation",
                                    class: "ai-assistant",
                                    icon: "fas fa-robot",
                                    handler: () => callAIForHelp(currentQuestion)
                                }, {
                                    text: "Forward Question",
                                    class: "forward-question",
                                    icon: "fas fa-share",
                                    handler: () => openForwardModal(currentQuestion)
                                }]);
                            }, 1500);
                            return;
                        }
                    } catch (error) {
                        console.error("Error searching documents:", error);
                    }
                }

                // If no results in documents or no documents uploaded
                setTimeout(() => {
                    addBotResponse(`I'm analyzing your question about "${message}". How would you like me to proceed?`, [{
                        text: "Search Wikipedia",
                        class: "wikipedia-search",
                        icon: "fab fa-wikipedia-w",
                        handler: () => performWikipediaSearch(currentQuestion)
                    }, {
                        text: "Google Search",
                        class: "google-search",
                        icon: "fab fa-google",
                        handler: () => performGoogleSearch(currentQuestion)
                    }, {
                        text: "AI Explanation",
                        class: "ai-assistant",
                        icon: "fas fa-robot",
                        handler: () => callAIForHelp(currentQuestion)
                    }, {
                        text: "Upload Materials",
                        class: "view-material",
                        icon: "fas fa-upload",
                        handler: () => fileInput.click()
                    }, {
                        text: "Forward Question",
                        class: "forward-question",
                        icon: "fas fa-share",
                        handler: () => openForwardModal(currentQuestion)
                    }]);
                }, 1500);
            }

            async function performWikipediaSearch(query) {
                showTyping();
                try {
                    const results = await searchWikipedia(query);
                    setTimeout(() => {
                        addBotResponse(results + `<div class="source-info">Information from Wikipedia</div>`);
                    }, 2000);
                } catch (error) {
                    setTimeout(() => {
                        addBotResponse("Sorry, I encountered an error while searching Wikipedia. Please try again.");
                    }, 2000);
                }
            }

            async function performGoogleSearch(query) {
                showTyping();
                try {
                    const results = await searchGoogle(query);
                    setTimeout(() => {
                        addBotResponse(results);
                    }, 2000);
                } catch (error) {
                    setTimeout(() => {
                        addBotResponse("Sorry, I encountered an error while searching Google. Please try again.");
                    }, 2000);
                }
            }

            async function callAIForHelp(query) {
                showTyping();
                try {
                    const response = await callAIForHelp(query);
                    setTimeout(() => {
                        addBotResponse(response);
                    }, 2500);
                } catch (error) {
                    setTimeout(() => {
                        addBotResponse("Sorry, I couldn't generate an AI response. Please try again or choose another option.");
                    }, 2500);
                }
            }

            function openForwardModal(question) {
                currentQuestion = question;
                forwardModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeForwardModal() {
                forwardModal.classList.remove('active');
                document.body.style.overflow = '';
            }

            function forwardQuestion(method) {
                closeForwardModal();

                let forwardMessage = `Question from ${studentName || 'a student'}: "${currentQuestion}"`;

                if (method === 'email') {
                    const subject = encodeURIComponent(`BMLT Assistant Question from ${studentName || 'Student'}`);
                    const body = encodeURIComponent(forwardMessage + "\n\nPlease provide an answer when you get a chance.");
                    window.open(`mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`, '_blank');

                    addBotResponse(`I've prepared an email with your question to Boadu Patrick. Please review and send it.`);
                } else if (method === 'whatsapp') {
                    const text = encodeURIComponent(forwardMessage);
                    window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${text}`, '_blank');

                    addBotResponse(`I've opened WhatsApp with your question to Boadu Patrick. Please review and send it.`);
                }
            }

            // Helper functions
            function isGreeting(message) {
                const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening'];
                return greetings.some(greet => message.toLowerCase().includes(greet));
            }

            function isThankYou(message) {
                const thanks = ['thank you', 'thanks', 'appreciate it', 'thanks a lot'];
                return thanks.some(thank => message.toLowerCase().includes(thank));
            }

            function isAskingAboutCapabilities(message) {
                const capabilityPhrases = [
                    'what can you do', 'how do you work', 'your capabilities',
                    'your functions', 'what do you do', 'help you can provide'
                ];
                return capabilityPhrases.some(phrase => message.toLowerCase().includes(phrase));
            }

            function isAskingForContact(message) {
                const contactPhrases = [
                    'contact you', 'reach you', 'your number', 'your phone',
                    'your whatsapp', 'your email', 'get in touch', 'speak to human'
                ];
                return contactPhrases.some(phrase => message.toLowerCase().includes(phrase));
            }

            function isAskingForSlides(message) {
                const slidePhrases = [
                    'slides', 'ppt', 'powerpoint', 'lecture notes',
                    'download slides', 'presentation', 'lecture materials'
                ];
                return slidePhrases.some(phrase => message.toLowerCase().includes(phrase));
            }

            function getContextFromContent(content, query) {
                const sentences = content.split(/[.!?]+/);
                for (const sentence of sentences) {
                    if (sentence.toLowerCase().includes(query.toLowerCase())) {
                        return sentence.trim() + ".";
                    }
                }
                return content.substring(0, 200) + "...";
            }
        });
    </script>
</body>

</html>